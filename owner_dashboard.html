<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Owner Dashboard – Hostel Hunt</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="style.css">

    <style>
        .action-btn {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
        }
        .btn-edit { background: #3b82f6; color: white; }
        .btn-delete { background: #ef4444; color: white; }
        .dashboard table td img { width: 60px; height: 45px; object-fit: cover; border-radius: 4px; }
        @media(max-width: 768px){ .table { font-size: 12px; } .table th, .table td { padding: 6px; } }
    </style>
</head>

<body>

<header>
  <div class="logo">Hostel Hunt</div>

  <nav id="mainNav" style="display:flex;align-items:center;gap:12px;">
    <a href="index.html">Home</a>
    <a href="owner_dashboard.html">Owner Dashboard</a>
    <a href="login.html" id="loginNav">Login</a>
    <a href="register.html" id="signupNav" class="btn">Sign up</a>

    <a href="#" id="meProfileLink" style="display:none;">
      <img id="navAvatar" src="https://via.placeholder.com/36"
           alt="Profile" style="width:36px;height:36px;border-radius:50%;vertical-align:middle;margin-right:8px;object-fit:cover;border:2px solid #fff;">
      <span id="navName" style="vertical-align:middle;font-weight:600;"></span>
    </a>

    <a href="#" id="logoutNav" style="display:none;color:#fff;background:#ef4444;padding:6px 10px;border-radius:6px;text-decoration:none;">Logout</a>
  </nav>
</header>

<section class="dashboard">
    <div class="dashboard-header">
        <div>
            <h2>Your Properties</h2>
            <p style="font-size:13px;color:#555;">
                Manage your PGs, hostels, flats and rooms.
            </p>
        </div>
        <a href="add_property.html" class="btn-primary">+ Add New Property</a>
    </div>

    <table class="table">
        <thead>
        <tr>
            <th>Image</th>
            <th>Title</th>
            <th>City</th>
            <th>Type</th>
            <th>Rent (₹)</th>
            <th>Beds</th>
            <th>Status</th>
            <th style="width:110px">Actions</th>
        </tr>
        </thead>

        <tbody id="propertyRows">
        <!-- JS injected rows -->
        </tbody>
    </table>

    <p id="dashboardMessage" class="small" style="margin-top:10px;color:#2563eb;"></p>
</section>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, deleteObject } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAOKTqpJmN-43fDQrZVmfGCVlK_8JBTrvY",
        authDomain: "hostelhunt-1df83.firebaseapp.com",
        projectId: "hostelhunt-1df83",
        storageBucket: "hostelhunt-1df83.firebasestorage.app",
        messagingSenderId: "272376261500",
        appId: "1:272376261500:web:719ada3e6b22090c5b12f9",
        measurementId: "G-0G66K64YFS"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // header elements
    const loginNav = document.getElementById("loginNav");
    const signupNav = document.getElementById("signupNav");
    const logoutNav = document.getElementById("logoutNav");
    const meProfileLink = document.getElementById("meProfileLink");
    const navAvatar = document.getElementById("navAvatar");
    const navName = document.getElementById("navName");

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            loginNav.style.display = "";
            signupNav.style.display = "";
            logoutNav.style.display = "none";
            meProfileLink.style.display = "none";
            // redirect if non-owner tries to view? existing logic will redirect later
            // but keep header consistent
        } else {
            loginNav.style.display = "none";
            signupNav.style.display = "none";
            logoutNav.style.display = "";
            meProfileLink.style.display = "";

            try {
                const snap = await (await import("https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js")).getDoc((await import("https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js")).doc(db, "users", user.uid));
            } catch (e) { /* ignore */ }

            navName.textContent = user.email.split("@")[0] || "User";
            navAvatar.src = user.photoURL || "https://via.placeholder.com/150";
        }
    });

    logoutNav.addEventListener("click", async (e) => {
        e.preventDefault();
        await signOut(auth);
        window.location.href = "login.html";
    });

    const rowsBody = document.getElementById("propertyRows");
    const msg = document.getElementById("dashboardMessage");

    function addRow(docId, p) {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td><img src="${p.imageURL || 'https://via.placeholder.com/100'}" /></td>
          <td>${p.title}</td>
          <td>${p.city}</td>
          <td>${p.type}</td>
          <td>${p.rent}</td>
          <td>${p.availableBeds || "-"}</td>
          <td>${p.status || "Active"}</td>
          <td>
            <button class="action-btn btn-edit" data-id="${docId}">Edit</button>
            <button class="action-btn btn-delete" data-id="${docId}">Delete</button>
          </td>
        `;

        rowsBody.appendChild(tr);
    }

    async function loadProperties(ownerId) {
        rowsBody.innerHTML = "";
        msg.textContent = "Loading properties...";

        try {
            const q = query(collection(db, "properties"), where("ownerId", "==", ownerId));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                msg.textContent = "No properties found. Add your first one!";
                return;
            }

            msg.textContent = "";
            snapshot.forEach(docSnap => {
                addRow(docSnap.id, docSnap.data());
            });

        } catch (err) {
            msg.style.color = "red";
            msg.textContent = err.message;
            console.error(err);
        }
    }

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            alert("Please login as owner to view dashboard.");
            window.location.href = "login.html";
        } else {
            loadProperties(user.uid);
        }
    });

    rowsBody.addEventListener("click", async (e) => {
        const id = e.target.dataset.id;
        if (!id) return;

        if (e.target.classList.contains("btn-edit")) {
            window.location.href = `edit_property.html?id=${id}`;
        }

        if (e.target.classList.contains("btn-delete")) {
            const confirmed = confirm("Are you sure you want to delete this property?");
            if (!confirmed) return;

            try {
                // Delete storage image if exists
                const docRef = doc(db, "properties", id);
                // read the doc
                const snap = await getDocs(query(collection(db, "properties"), where("__name__", "==", id)));
                if (!snap.empty) {
                    const data = snap.docs[0].data();
                    if (data.imagePath) {
                        const imgRef = storageRef(storage, data.imagePath);
                        await deleteObject(imgRef).catch(() => {});
                    }
                }

                await deleteDoc(doc(db, "properties", id));
                alert("Property deleted.");
                location.reload();

            } catch (err) {
                console.error(err);
                alert("Error deleting: " + err.message);
            }
        }
    });

</script>

</body>
</html>
